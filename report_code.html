<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kayak Cross Race Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .x-axis path,
        .y-axis path {
            display: none;
        }

        .x-axis .tick line,
        .y-axis .tick line {
            stroke: #334155;
            stroke-dasharray: 2, 2;
        }

        .x-axis .tick text {
            fill: #94a3b8;
            font-size: 12px;
            font-weight: 600;
        }

        .y-axis .tick text {
            fill: #94a3b8;
            font-size: 14px;
            font-weight: 700;
        }

        .domain {
            display: none;
        }

        .dark-select,
        .dark-input {
            background-color: #1e293b;
            border-color: #475569;
            color: #e2e8f0;
        }

        .tooltip {
            position: absolute;
            text-align: left;
            padding: 8px;
            font: 12px sans-serif;
            background: #1e293b;
            color: white;
            border: 1px solid #334155;
            border-radius: 8px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 50;
        }

        .chart-card {
            transition: border-color 0.3s ease-in-out;
        }

        @keyframes pulse-green {
            0% {
                box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7);
            }

            70% {
                box-shadow: 0 0 0 6px rgba(34, 197, 94, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(34, 197, 94, 0);
            }
        }

        .live-indicator {
            animation: pulse-green 2s infinite;
        }
    </style>
</head>

<body class="bg-slate-900 text-slate-200 antialiased">
    <div class="tooltip"></div>
    <div class="container mx-auto p-4 md:p-8">
        <header class="flex flex-col lg:flex-row justify-between items-center mb-8 relative">
            <div class="w-full text-center lg:absolute lg:left-0 lg:right-0 pointer-events-none mb-2 lg:mb-0">
                <h1 class="text-3xl font-bold text-slate-100 pointer-events-auto inline-block">Kayak Cross Analysis</h1>
            </div>
            <div id="last-updated"
                class="lg:ml-auto text-[10px] md:text-xs text-slate-500 font-mono z-10 relative flex items-center gap-2 max-w-md text-right overflow-hidden whitespace-nowrap text-ellipsis">
            </div>
        </header>

        <div class="max-w-7xl mx-auto mb-8 border-b border-slate-700">
            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                <button id="tab-full"
                    class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-indigo-400 border-indigo-500">
                    Full Report
                </button>
                <button id="tab-compact"
                    class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-slate-400 border-transparent hover:text-slate-300 hover:border-slate-500">
                    In-Competition Report
                </button>
                <button id="tab-athlete"
                    class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-slate-400 border-transparent hover:text-slate-300 hover:border-slate-500">
                    Athlete Profile
                </button>
                <button id="tab-summary"
                    class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-slate-400 border-transparent hover:text-slate-300 hover:border-slate-500">
                    Season Summary
                </button>
            </nav>
        </div>

        <!-- FULL REPORT CONTAINER -->
        <div id="report-full">
            <div class="max-w-7xl mx-auto space-y-8">
                <div id="filter-controls-full"
                    class="bg-slate-800 p-4 rounded-xl shadow-md border border-slate-700 mb-8 hidden">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div>
                            <label for="year-select-full"
                                class="block text-sm font-medium text-slate-300 mb-1">Year</label>
                            <select id="year-select-full"
                                class="dark-select w-full rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></select>
                        </div>
                        <div>
                            <label for="competition-select-full"
                                class="block text-sm font-medium text-slate-300 mb-1">Competition</label>
                            <select id="competition-select-full"
                                class="dark-select w-full rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></select>
                        </div>
                        <div>
                            <label for="gender-select-full"
                                class="block text-sm font-medium text-slate-300 mb-1">Gender</label>
                            <select id="gender-select-full"
                                class="dark-select w-full rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></select>
                        </div>
                        <div>
                            <label for="phase-select-full"
                                class="block text-sm font-medium text-slate-300 mb-1">Phase</label>
                            <select id="phase-select-full"
                                class="dark-select w-full rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></select>
                        </div>
                    </div>
                </div>
            </div>
            <div id="charts-area-full" class="max-w-7xl mx-auto mt-8 grid grid-cols-1 lg:grid-cols-5 gap-8 items-start">
                <div class="lg:col-span-3 flex flex-col gap-8">
                    <div class="bg-slate-800 p-4 sm:p-6 rounded-xl shadow-md border border-slate-700 chart-card">
                        <h3 class="text-xl font-semibold text-slate-100 mb-4 text-center">CLSX Head to Head Race Analysis</h3>
                        <div id="legend-full" class="flex justify-center space-x-4 mb-4"></div>
                        <div id="chart-container-full" class="w-full h-[600px]">
                            <svg id="chart-full" class="w-full h-full"></svg>
                        </div>
                    </div>
                    <div id="fault-analysis-full"
                        class="bg-slate-800 p-4 sm:p-6 rounded-xl shadow-md border border-slate-700 hidden"></div>
                </div>

                <div class="lg:col-span-2 grid grid-cols-2 gap-4">
                    <div class="bg-slate-800 p-2 sm:p-4 rounded-xl shadow-md border border-slate-700 chart-card">
                        <h3 class="text-sm font-semibold text-slate-100 mb-4 text-center leading-tight">Overall Win % by Bib Color</h3>
                        <div id="pie-chart-bib-full" class="w-full h-40 flex items-center justify-center"></div>
                        <div id="pie-legend-bib-full" class="flex flex-col items-center gap-y-2 mt-4"></div>
                    </div>
                    <div class="bg-slate-800 p-2 sm:p-4 rounded-xl shadow-md border border-slate-700 chart-card">
                        <h3 class="text-sm font-semibold text-slate-100 mb-4 text-center leading-tight">Overall 2nd Place % by Bib Color</h3>
                        <div id="pie-chart-bib-second-full" class="w-full h-40 flex items-center justify-center"></div>
                        <div id="pie-legend-bib-second-full" class="flex flex-col items-center gap-y-2 mt-4"></div>
                    </div>
                    <div class="bg-slate-800 p-2 sm:p-4 rounded-xl shadow-md border border-slate-700 chart-card">
                        <h3 class="text-sm font-semibold text-slate-100 mb-4 text-center leading-tight">Finish Position % when Leading at 1st Upstream</h3>
                        <div id="pie-chart-gate2-full" class="w-full h-40 flex items-center justify-center"></div>
                        <div id="pie-legend-gate2-full" class="flex flex-col items-center gap-y-2 mt-4"></div>
                    </div>
                    <div class="bg-slate-800 p-2 sm:p-4 rounded-xl shadow-md border border-slate-700 chart-card">
                        <h3 class="text-sm font-semibold text-slate-100 mb-4 text-center leading-tight">Rank at 1st Upstream When Overall Finish 2nd</h3>
                        <div id="pie-chart-gate2-second-full" class="w-full h-40 flex items-center justify-center"></div>
                        <div id="pie-legend-gate2-second-full" class="flex flex-col items-center gap-y-2 mt-4"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- COMPACT / IN-COMPETITION REPORT CONTAINER -->
        <div id="report-compact" class="hidden">
            <div class="max-w-7xl mx-auto space-y-8">
                <div id="filter-controls-compact"
                    class="bg-slate-800 p-4 rounded-xl shadow-md border border-slate-700 mb-8 hidden">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div>
                            <label for="year-select-compact"
                                class="block text-sm font-medium text-slate-300 mb-1">Year</label>
                            <select id="year-select-compact"
                                class="dark-select w-full rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></select>
                        </div>
                        <div>
                            <label for="competition-select-compact"
                                class="block text-sm font-medium text-slate-300 mb-1">Competition</label>
                            <select id="competition-select-compact"
                                class="dark-select w-full rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></select>
                        </div>
                        <div>
                            <label for="gender-select-compact"
                                class="block text-sm font-medium text-slate-300 mb-1">Gender</label>
                            <select id="gender-select-compact"
                                class="dark-select w-full rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></select>
                        </div>
                        <div>
                            <label for="phase-select-compact"
                                class="block text-sm font-medium text-slate-300 mb-1">Phase</label>
                            <select id="phase-select-compact"
                                class="dark-select w-full rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></select>
                        </div>
                    </div>
                </div>
            </div>
            <div id="charts-area-compact" class="max-w-7xl mx-auto mt-8 grid grid-cols-1 lg:grid-cols-5 gap-8 items-start">
                <div class="lg:col-span-3 flex flex-col gap-8">
                    <div class="bg-slate-800 p-4 sm:p-6 rounded-xl shadow-md border border-slate-700 chart-card">
                        <h3 class="text-xl font-semibold text-slate-100 mb-4 text-center">CLSX Head to Head Race Analysis</h3>
                        <div id="legend-compact" class="flex justify-center space-x-4 mb-4"></div>
                        <div id="chart-container-compact" class="w-full h-[600px]">
                            <svg id="chart-compact" class="w-full h-full"></svg>
                        </div>
                    </div>
                    <div id="fault-analysis-compact"
                        class="bg-slate-800 p-4 sm:p-6 rounded-xl shadow-md border border-slate-700 hidden"></div>
                </div>

                <div class="lg:col-span-2 grid grid-cols-2 gap-4">
                    <div class="bg-slate-800 p-2 sm:p-4 rounded-xl shadow-md border border-slate-700 chart-card flex flex-col justify-center">
                        <h3 class="text-xs font-semibold text-slate-100 mb-4 text-center leading-tight">Overall Win %<br>by Bib Color</h3>
                        <div id="pie-chart-bib-compact" class="w-full h-32 flex items-center justify-center"></div>
                        <div id="pie-legend-bib-compact" class="flex flex-col items-center gap-y-1 mt-2"></div>
                    </div>
                    <div class="bg-slate-800 p-2 sm:p-4 rounded-xl shadow-md border border-slate-700 chart-card flex flex-col justify-center">
                        <h3 class="text-xs font-semibold text-slate-100 mb-4 text-center leading-tight">Overall 2nd Place %<br>by Bib Color</h3>
                        <div id="pie-chart-bib-second-compact" class="w-full h-32 flex items-center justify-center"></div>
                        <div id="pie-legend-bib-second-compact" class="flex flex-col items-center gap-y-1 mt-2"></div>
                    </div>
                    <div class="bg-slate-800 p-2 sm:p-4 rounded-xl shadow-md border border-slate-700 chart-card flex flex-col justify-center">
                        <h3 class="text-xs font-semibold text-slate-100 mb-4 text-center leading-tight">Win %<br>by Ramp Position</h3>
                        <div id="pie-chart-ramp-compact" class="w-full h-32 flex items-center justify-center"></div>
                        <div id="pie-legend-ramp-compact" class="flex flex-col items-center gap-y-1 mt-2"></div>
                    </div>
                    <div class="bg-slate-800 p-2 sm:p-4 rounded-xl shadow-md border border-slate-700 chart-card flex flex-col justify-center">
                        <h3 class="text-xs font-semibold text-slate-100 mb-4 text-center leading-tight">2nd Place %<br>by Ramp Position</h3>
                        <div id="pie-chart-ramp-second-compact" class="w-full h-32 flex items-center justify-center"></div>
                        <div id="pie-legend-ramp-second-compact" class="flex flex-col items-center gap-y-1 mt-2"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ATHLETE PROFILE CONTAINER -->
        <div id="report-athlete" class="hidden">
            <div class="max-w-7xl mx-auto space-y-8">
                <div id="athlete-search-controls" class="bg-slate-800 p-6 rounded-xl shadow-md border border-slate-700 space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label for="year-select-athlete" class="block text-sm font-medium text-slate-300 mb-2">Year</label>
                            <select id="year-select-athlete" class="dark-select w-full rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></select>
                        </div>
                        <div>
                            <label for="competition-select-athlete" class="block text-sm font-medium text-slate-300 mb-2">Competition</label>
                            <select id="competition-select-athlete" class="dark-select w-full rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></select>
                        </div>
                        <div>
                            <label for="gender-select-athlete" class="block text-sm font-medium text-slate-300 mb-2">Gender</label>
                            <select id="gender-select-athlete" class="dark-select w-full rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 border-t border-slate-700 pt-6">
                        <div>
                            <label for="athlete-select-1" class="block text-sm font-medium text-slate-300 mb-2">Athlete 1</label>
                            <select id="athlete-select-1" class="athlete-select dark-select w-full rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></select>
                        </div>
                        <div>
                            <label for="athlete-select-2" class="block text-sm font-medium text-slate-300 mb-2">Athlete 2</label>
                            <select id="athlete-select-2" class="athlete-select dark-select w-full rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></select>
                        </div>
                        <div>
                            <label for="athlete-select-3" class="block text-sm font-medium text-slate-300 mb-2">Athlete 3</label>
                            <select id="athlete-select-3" class="athlete-select dark-select w-full rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></select>
                        </div>
                    </div>
                </div>
                <div id="athlete-profile-area" class="mt-8"></div>
            </div>
        </div>

        <!-- SEASON SUMMARY CONTAINER -->
        <div id="report-summary" class="hidden">
            <div class="max-w-7xl mx-auto space-y-8">
                <div class="bg-slate-800 p-6 rounded-xl shadow-md border border-slate-700">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="year-select-summary" class="block text-sm font-medium text-slate-300 mb-2">Year</label>
                            <select id="year-select-summary" class="dark-select w-full rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></select>
                        </div>
                        <div>
                            <label for="athlete-select-summary" class="block text-sm font-medium text-slate-300 mb-2">Athlete</label>
                            <select id="athlete-select-summary" class="dark-select w-full rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></select>
                        </div>
                    </div>
                </div>
                <div id="summary-content-area" class="mt-8"></div>
            </div>
        </div>
    </div>

    <script>
        // --- DATA STATE & CONSTANTS ---
        let masterDataFull = [];
        let masterDataCompact = [];
        const bibColors = { 'R': '#ef4444', 'G': '#22c55e', 'B': '#3b82f6', 'Y': '#eab308' };
        const bibFullNames = { 'R': 'RED', 'G': 'GREEN', 'B': 'BLUE', 'Y': 'YELLOW' };
        const medalColors = { gold: '#D4AF37', silver: '#C0C0C0', bronze: '#A97142' };

        // DOM elements
        let tooltip, tabFull, tabCompact, tabAthlete, tabSummary;
        let reportFull, reportCompact, reportAthlete, reportSummary, lastUpdatedEl;
        let selectorsFull, filterControlsFull, selectorsCompact, filterControlsCompact, selectorsAthlete, selectorsSummary;

        function setActiveTab(activeTab) {
            const tabs = [tabFull, tabCompact, tabAthlete, tabSummary];
            const reports = [reportFull, reportCompact, reportAthlete, reportSummary];
            tabs.forEach(tab => {
                const isActive = tab.node() === activeTab.node();
                tab.classed("text-indigo-400 border-indigo-500", isActive).classed("text-slate-400 border-transparent", !isActive);
            });
            reports.forEach((report, index) => {
                report.classed("hidden", tabs[index].node() !== activeTab.node());
            });
        }

        function formatAthleteName(name) {
            if (!name || typeof name !== 'string') return '';
            const parts = name.trim().split(/\s+/);
            if (parts.length >= 2) {
                const lastName = parts[0].toUpperCase();
                const firstName = parts.slice(1).map(part => part.charAt(0).toUpperCase() + part.slice(1).toLowerCase()).join(' ');
                return `${lastName} ${firstName}`;
            }
            return name.toUpperCase();
        }

        function parseCsvData(csvString) {
            return d3.csvParse(csvString, (d) => {
                for (let key in d) { if (d[key] && typeof d[key] === 'string') d[key] = d[key].trim(); }
                const year = +d.Year || 0;
                const competition = d.Competition || '';
                const gender = d.Gender || '';
                const phase = d.Phase || '';
                let gate = d.Gate || '';
                if (gate.startsWith('Gate ')) gate = gate.replace('Gate ', '');
                else if (gate === 'Course') gate = 'Roll';

                const bib = d.BIB || d.Bib || '';
                const position = +(d.Order || d.Position || 0);
                const rampPosition = +(d['Ramp Position'] || d['RampPosition'] || 0);
                const finalPosition = +(d['Final Position'] || d['FinalPosition'] || 0);
                const upstreamTactic = d['Upstream Tactic'] || d['UpstreamTactic'] || '';
                const athleteName = d['Athlete Name'] || d['Athlete'] || d['Name'] || '';
                const action = d.Action || d.action || d.Notes || d.notes || '';
                const faultVal = d.Fault || d.fault || '';
                const finishRank = d['Finish Rank'] || d['FinishRank'] || d.Rank || d.rank || d['Overall Rank'] || d['OverallRank'] || '';

                return { Year: year, Competition: competition, Gender: gender, Phase: phase, Gate: gate, BIB: bib, Position: position, RampPosition: rampPosition, FinalPosition: finalPosition, UpstreamTactic: upstreamTactic, AthleteName: athleteName, Action: action, FaultVal: faultVal, FinishRank: finishRank };
            });
        }

        function scanCompetitionStructure(year, competition, allData) {
            const compData = allData.filter(d => d.Year === year && d.Competition === competition);
            if (compData.length === 0) return { orderedGates: ['1', '2', '3', '4', '5', '6', 'Roll', '7', '8'], upstreamGates: ['2', '8'] };

            const detectedUpstreams = new Set();
            compData.forEach(d => {
                const gate = d.Gate;
                if (!gate || gate === 'Ramp' || gate === 'Start' || gate === 'Finish') return;
                const action = (d.Action || "").toUpperCase();
                const tactic = (d.UpstreamTactic || "").toUpperCase();
                if (action.includes('UP') || tactic.trim().length > 0) detectedUpstreams.add(gate);
            });

            const runs = {};
            compData.forEach(d => {
                const runId = `${d.Phase}-${d.Gender}-${d.BIB}`;
                if (!runs[runId]) runs[runId] = [];
                if (d.Gate && d.Gate !== 'Start' && d.Gate !== 'Finish' && d.Gate !== 'Ramp') runs[runId].push(d.Gate);
            });

            let longestSequence = [];
            Object.values(runs).forEach(seq => { if (seq.length > longestSequence.length) longestSequence = seq; });
            const finalOrder = [...new Set(longestSequence)];
            return { orderedGates: finalOrder.length > 0 ? finalOrder : [...new Set(compData.map(d => d.Gate))].filter(g => g && g !== 'Start' && g !== 'Finish' && g !== 'Ramp'), upstreamGates: Array.from(detectedUpstreams) };
        }

        // --- CALC LOGIC FOR COLORING & TACTICS (IN-COMPETITION) ---
        function calculateTacticLogic(raceData, upstreamGates, gateMapping = {}) {
            const uppers = upstreamGates.filter(g => {
                const label = (gateMapping[g] || g).toUpperCase();
                return label.includes('UP');
            });

            raceData.forEach(d => d.displayTactic = "");

            uppers.forEach(gate => {
                const gateEvents = raceData.filter(d => d.Gate === gate).sort((a, b) => a.Position - b.Position);
                if (gateEvents.length === 0) return;
                
                const leader = gateEvents[0];
                leader.displayTactic = leader.UpstreamTactic || "";

                for (let i = 1; i < gateEvents.length; i++) {
                    const current = gateEvents[i];
                    const ahead = gateEvents[i - 1];
                    if (current.Action && ahead.Action) {
                        if (current.Action.toUpperCase() === ahead.Action.toUpperCase()) {
                            current.displayTactic = 'FOLLOW';
                        } else {
                            current.displayTactic = `SPLIT - ${current.Action.toUpperCase()}`;
                        }
                    } else {
                        current.displayTactic = current.UpstreamTactic;
                    }
                }
            });
        }

        function getGateColor(d, upstreamGates, rollGates) {
            const val = String(d).toUpperCase();
            if (val === 'START' || val === 'FINISH') return '#334155';
            if (val === 'ROLL' || (rollGates && rollGates.some(g => String(g).toUpperCase() === val))) return '#eab308';
            
            const isUp = val.includes('UP') || (upstreamGates && upstreamGates.some(g => String(g).toUpperCase() === val));
            return isUp ? '#ef4444' : '#22c55e';
        }

        function getCalculatedRaceResults(raceData, orderedGates) {
            const faultData = raceData.filter(d => {
                const check = (s) => s && (s.toUpperCase().includes('FLT') || s.toUpperCase().includes('FAULT') || s.toUpperCase().includes('DSQ') || s.toUpperCase().includes('DNF') || s.toUpperCase().includes('RAL'));
                return check(d.Action) || check(d.Gate) || check(d.FaultVal);
            });
            const bibs = [...new Set(raceData.map(d => d.BIB))];
            const stats = bibs.map(bib => {
                const f = faultData.filter(d => d.BIB === bib);
                const n = raceData.find(d => d.BIB === bib && d.AthleteName);
                const name = n ? formatAthleteName(n.AthleteName) : bib;
                let isRAL = false, deepest = -1;
                const fStrs = f.map(x => {
                    const raw = (x.Gate + " " + x.FaultVal + " " + x.Action).toUpperCase();
                    if (raw.includes("RAL")) isRAL = true;
                    let cg = (x.Gate || "").replace(/FLT|FAULT|DSQ|DNF|RAL/gi, '').trim();
                    let idx = orderedGates.indexOf(cg);
                    if (idx > deepest) deepest = idx;
                    return raw.includes("RAL") ? "RAL" : (cg ? `FLT ${cg}` : "Fault");
                });
                const fin = raceData.find(d => d.BIB === bib && d.FinalPosition > 0);
                const rmp = raceData.find(d => d.BIB === bib && d.Gate === 'Ramp');
                const frnk = raceData.find(d => d.BIB === bib && d.FinishRank);
                return { bib, name, rampPosition: rmp ? rmp.RampPosition : '-', faults: fStrs, faultCount: fStrs.length, deepestFaultIndex: deepest, originalRank: fin ? fin.FinalPosition : 99, isRAL, finishRank: frnk ? frnk.FinishRank : '-' };
            });
            const sorted = stats.sort((a, b) => {
                if (a.isRAL !== b.isRAL) return a.isRAL ? 1 : -1;
                if (a.faultCount !== b.faultCount) {
                    const gA = a.faultCount === 0 ? 0 : (a.faultCount === 1 ? 1 : 2);
                    const gB = b.faultCount === 0 ? 0 : (b.faultCount === 1 ? 1 : 2);
                    if (gA !== gB) return gA - gB;
                }
                if (a.deepestFaultIndex !== b.deepestFaultIndex) return b.deepestFaultIndex - a.deepestFaultIndex;
                return a.originalRank - b.originalRank;
            });
            sorted.forEach((a, i) => a.calculatedRank = i + 1);
            return sorted;
        }

        // --- CHART DRAWING HELPERS ---
        function drawLineChart(id, raceData, rampPositions, bibToNameMap, courseOrder, domain, upstreamGates, rollGates, yMax) {
            const svg = d3.select(id); svg.selectAll("*").remove();
            if (!raceData.length) return;
            const container = d3.select(id === "#chart-full" ? "#chart-container-full" : "#chart-container-compact");
            const { width, height } = container.node().getBoundingClientRect();
            const margin = { top: 50, right: 20, bottom: 20, left: 90 };
            const chart = svg.append("g").attr("transform", `translate(${margin.left}, ${margin.top})`);
            
            const defs = svg.append('defs');
            const patternId = `checkered-flag-${id.replace('#', '')}`;
            const pattern = defs.append('pattern').attr('id', patternId).attr('width', 8).attr('height', 8).attr('patternUnits', 'userSpaceOnUse');
            pattern.append('rect').attr('width', 8).attr('height', 8).attr('fill', 'white');
            pattern.append('rect').attr('width', 4).attr('height', 4).attr('fill', '#1e293b');
            pattern.append('rect').attr('x', 4).attr('y', 4).attr('width', 4).attr('height', 4).attr('fill', '#1e293b');

            const xScale = d3.scalePoint().domain(domain).range([0, width - margin.left - margin.right]).padding(0.5);
            const yScale = d3.scaleLinear().domain([0.8, yMax + 0.2]).range([0, height - margin.top - margin.bottom]);

            const xAxis = chart.append("g").attr("class", "x-axis").call(d3.axisTop(xScale).tickValues([...courseOrder, 'Finish']).tickSize(-(height - margin.top - margin.bottom)));
            xAxis.selectAll(".tick line").style("stroke", d => getGateColor(d, upstreamGates, rollGates)).style("stroke-opacity", d => ['START', 'FINISH'].includes(String(d).toUpperCase()) ? 0.2 : 0.4);
            xAxis.selectAll(".tick text").style("fill", d => ['START', 'FINISH'].includes(String(d).toUpperCase()) ? '#94a3b8' : getGateColor(d, upstreamGates, rollGates));

            const finishTick = xAxis.selectAll(".tick").filter(d => String(d).toUpperCase() === 'FINISH');
            if (!finishTick.empty()) {
                const finishTextNode = finishTick.select('text').node();
                if (finishTextNode) {
                    const bbox = finishTextNode.getBBox();
                    finishTick.insert('rect', 'text').attr('x', bbox.x - 4).attr('y', bbox.y + bbox.height + 2).attr('width', bbox.width + 8).attr('height', 4).attr('fill', `url(#${patternId})`);
                }
            }

            chart.append("g").attr("class", "y-axis").call(d3.axisLeft(yScale).tickValues(d3.range(1, yMax + 1)).tickFormat(d => d > yMax ? '' : d).tickSize(-(width - margin.left - margin.right))).selectAll(".tick text").style("fill", d => d === 1 ? medalColors.gold : d === 2 ? medalColors.silver : d === 3 ? medalColors.bronze : '#94a3b8');

            // --- RESTORED: Ramp Pos and Athlete Labels on Left ---
            if (rampPositions.size > 0) {
                const sortedRamps = Array.from(rampPositions).sort((a, b) => a[1] - b[1]);
                chart.append("text")
                    .attr("x", -10)
                    .attr("y", yScale(yMax) - (sortedRamps.length * 10) - 4)
                    .attr("text-anchor", "end")
                    .style("font-size", "10px")
                    .style("font-weight", "bold")
                    .style("fill", "#94a3b8")
                    .text("Ramp Pos:");

                sortedRamps.forEach(([bib, pos], i) => {
                    const fullName = bibToNameMap.get(bib);
                    const lastName = fullName ? fullName.split(' ')[0] : (bibFullNames[bib] || bib);
                    const textNode = chart.append("text")
                        .attr("x", -10)
                        .attr("y", yScale(yMax) - (sortedRamps.length * 6) + ((i + 1) * 12))
                        .attr("text-anchor", "end")
                        .style("fill", bibColors[bib])
                        .style("font-size", "10px");
                    
                    textNode.append("tspan").style("font-weight", "bold").text(`${lastName}: `);
                    textNode.append("tspan").style("font-weight", "normal").text(pos);
                });
            }

            const grouped = d3.group(raceData, d => d.BIB);
            const line = d3.line().x(d => xScale(d.Gate)).y(d => yScale(d.Position));
            const yOffsetTracker = {};

            grouped.forEach((vals, key) => {
                chart.append("path").datum(vals.sort((a, b) => domain.indexOf(a.Gate) - domain.indexOf(b.Gate))).attr("fill", "none").attr("stroke", bibColors[key]).attr("stroke-width", 3).attr("d", line);
                chart.selectAll(`.dot-${key}`).data(vals.filter(v => v.Gate !== 'Start')).join("circle").attr("cx", d => xScale(d.Gate)).attr("cy", d => yScale(d.Position)).attr("r", 5).attr("fill", bibColors[key]).attr("stroke", "#0f172a");

                vals.forEach(d => {
                    const isUp = getGateColor(d.Gate, upstreamGates, rollGates) === '#ef4444';
                    if (isUp && d.displayTactic) {
                        if (!yOffsetTracker[d.Gate]) yOffsetTracker[d.Gate] = [];
                        const yBase = yScale(d.Position);
                        let yPos = yBase - 12;
                        if (yOffsetTracker[d.Gate].some(ey => Math.abs(ey - yPos) < 15)) yPos = yBase + 20;
                        yOffsetTracker[d.Gate].push(yPos);

                        // Dynamic text color matching the line color (bibColors[key])
                        const txt = chart.append("text").attr("x", xScale(d.Gate)).attr("y", yPos).attr("text-anchor", "middle").style("fill", bibColors[key]).style("font-size", "10px").style("font-weight", "bold");
                        if (d.displayTactic.includes(' - ')) {
                            const p = d.displayTactic.split(' - ');
                            txt.append("tspan").text(p[0] + ' - ');
                            txt.append("tspan").style("font-size", "8px").style("font-weight", "normal").text(p[1]);
                        } else txt.text(d.displayTactic);
                    }
                });
            });

            const leg = d3.select(id === "#chart-full" ? "#legend-full" : "#legend-compact");
            leg.selectAll("*").remove();
            leg.selectAll("div").data([...grouped.keys()].sort((a, b) => ['R', 'G', 'B', 'Y'].indexOf(a) - ['R', 'G', 'B', 'Y'].indexOf(b))).join("div").attr("class", "flex items-center mx-2")
                .html(d => `<div class="w-3 h-3 rounded-sm mr-2" style="background-color:${bibColors[d]}"></div><span class="text-sm font-medium text-slate-300">${bibToNameMap.get(d) || bibFullNames[d]}</span>`);
        }

        // --- FULL REPORT UPDATER ---
        function updateAllChartsFull() {
            if (!masterDataFull.length) return;
            const sel = { year: +selectorsFull.year.property("value"), comp: selectorsFull.competition.property("value"), gen: selectorsFull.gender.property("value"), pha: selectorsFull.phase.property("value") };
            const struct = scanCompetitionStructure(sel.year, sel.comp, masterDataFull);
            const raw = masterDataFull.filter(d => d.Year === sel.year && d.Competition === sel.comp && d.Gender === sel.gen && d.Phase === sel.pha);
            
            calculateTacticLogic(raw, struct.upstreamGates);
            const nameMap = new Map(); const ramps = new Map();
            raw.filter(d => d.Gate === 'Ramp').forEach(d => { nameMap.set(d.BIB, formatAthleteName(d.AthleteName)); ramps.set(d.BIB, d.RampPosition); });
            
            let data = [];
            [...new Set(raw.map(d => d.BIB))].forEach(b => {
                const aData = raw.filter(d => d.BIB === b);
                const fin = aData.find(d => d.FinalPosition > 0);
                data.push({ BIB: b, Gate: 'Start', Position: 5 });
                data.push(...aData.filter(d => d.Gate !== 'Ramp' && d.Gate !== 'Finish' && d.Position > 0));
                if (fin) data.push({ BIB: b, Gate: 'Finish', Position: fin.FinalPosition });
            });
            drawLineChart("#chart-full", data, ramps, nameMap, struct.orderedGates, ['Start', ...struct.orderedGates, 'Finish'], struct.upstreamGates, [], 5);
            updateFaultAnalysis("#fault-analysis-full", raw, struct.orderedGates, nameMap);

            // Pie charts for Full Report
            const agg = masterDataFull.filter(d => d.Year === sel.year && d.Competition === sel.comp && d.Gender === sel.gen);
            const uniqueFinalPositions = [];
            const seenEntries = new Set();
            agg.filter(d => d.FinalPosition > 0).forEach(d => {
                const key = `${d.Phase}-${d.BIB}`;
                if (!seenEntries.has(key)) { seenEntries.add(key); uniqueFinalPositions.push(d); }
            });
            const winnersData = uniqueFinalPositions.filter(d => d.FinalPosition === 1);
            const allBibLabels = Object.values(bibFullNames).sort();
            const bibColorScale = d3.scaleOrdinal().domain(allBibLabels).range(allBibLabels.map(label => bibColors[Object.keys(bibFullNames).find(key => bibFullNames[key] === label)]));
            const bibWinnerCounts = d3.rollup(winnersData, v => v.length, d => bibFullNames[d.BIB]);
            drawPieChartAndLegend("#pie-chart-bib-full", "#pie-legend-bib-full", allBibLabels.map(l => ({ label: l, value: bibWinnerCounts.get(l) || 0 })), bibColorScale);
            
            const secondPlaceData = uniqueFinalPositions.filter(d => d.FinalPosition === 2);
            const bibSecondCounts = d3.rollup(secondPlaceData, v => v.length, d => bibFullNames[d.BIB]);
            drawPieChartAndLegend("#pie-chart-bib-second-full", "#pie-legend-bib-second-full", allBibLabels.map(l => ({ label: l, value: bibSecondCounts.get(l) || 0 })), bibColorScale);

            const gate2Leaders = agg.filter(d => d.Gate === '2' && d.Position === 1);
            const finOfLeaders = new Map([[1, 0], [2, 0], [3, 0], [4, 0]]);
            gate2Leaders.forEach(l => {
                const f = uniqueFinalPositions.find(d => d.Phase === l.Phase && d.BIB === l.BIB);
                if (f) finOfLeaders.set(f.FinalPosition, (finOfLeaders.get(f.FinalPosition) || 0) + 1);
            });
            const gate2Data = [1, 2, 3, 4].map(p => ({ label: `Finished ${p}${p === 1 ? 'st' : p === 2 ? 'nd' : p === 3 ? 'rd' : 'th'}`, value: finOfLeaders.get(p) || 0 }));
            drawPieChartAndLegend("#pie-chart-gate2-full", "#pie-legend-gate2-full", gate2Data, d3.scaleOrdinal().domain(gate2Data.map(d => d.label)).range([medalColors.gold, medalColors.silver, medalColors.bronze, '#FFFFFF']));
            
            const secondPlaceFinishers = uniqueFinalPositions.filter(d => d.FinalPosition === 2);
            const secondPlaceGate2Positions = new Map([[1, 0], [2, 0], [3, 0], [4, 0]]);
            secondPlaceFinishers.forEach(finisher => {
                const gate2Performance = agg.find(d => d.Phase === finisher.Phase && d.BIB === finisher.BIB && d.Gate === '2');
                if (gate2Performance) secondPlaceGate2Positions.set(gate2Performance.Position, (secondPlaceGate2Positions.get(gate2Performance.Position) || 0) + 1);
            });
            const gate2SecondData = [1, 2, 3, 4].map(p => ({ label: `${p}${p === 1 ? 'st' : p === 2 ? 'nd' : p === 3 ? 'rd' : 'th'} at Gate 2`, value: secondPlaceGate2Positions.get(p) || 0 }));
            drawPieChartAndLegend("#pie-chart-gate2-second-full", "#pie-legend-gate2-second-full", gate2SecondData, d3.scaleOrdinal().domain(gate2SecondData.map(d => d.label)).range([medalColors.gold, medalColors.silver, medalColors.bronze, '#FFFFFF']));
        }

        // --- COMPACT REPORT UPDATER ---
        function updateAllChartsCompact() {
            if (!masterDataCompact.length) return;
            const sel = { year: +selectorsCompact.year.property("value"), comp: selectorsCompact.competition.property("value"), gen: selectorsCompact.gender.property("value"), pha: selectorsCompact.phase.property("value") };
            const struct = scanCompetitionStructure(sel.year, sel.comp, masterDataCompact);
            const raw = masterDataCompact.filter(d => d.Year === sel.year && d.Competition === sel.comp && d.Gender === sel.gen && d.Phase === sel.pha);
            
            const mapping = {};
            if (struct.orderedGates.includes('1')) mapping['1'] = '1';
            if (struct.upstreamGates.length > 0) mapping[struct.upstreamGates[0]] = '1st Up';
            if (struct.upstreamGates.length > 1) mapping[struct.upstreamGates[1]] = '2nd Up';
            const next = struct.orderedGates.find(g => g === '3' || g === 'Next Gate');
            if (next) mapping[next] = 'Next Gate';
            if (struct.orderedGates.includes('Roll')) mapping['Roll'] = 'Roll';

            calculateTacticLogic(raw, struct.upstreamGates, mapping);
            const nameMap = new Map(); const ramps = new Map();
            raw.filter(d => d.Gate === 'Ramp').forEach(d => { nameMap.set(d.BIB, formatAthleteName(d.AthleteName)); ramps.set(d.BIB, d.RampPosition); });

            const displayOrder = struct.orderedGates.map(g => mapping[g]).filter(l => l);
            let data = [];
            [...new Set(raw.map(d => d.BIB))].forEach(b => {
                const aData = raw.filter(d => d.BIB === b);
                data.push({ BIB: b, Gate: 'Start', Position: 4.5 });
                data.push(...aData.filter(d => d.Gate !== 'Ramp' && d.Gate !== 'Finish' && d.Position > 0).map(d => ({ ...d, Gate: mapping[d.Gate] || d.Gate })).filter(d => displayOrder.includes(d.Gate)));
                const fin = aData.find(d => d.FinalPosition > 0);
                if (fin) data.push({ BIB: b, Gate: 'Finish', Position: fin.FinalPosition });
            });
            
            const upMapped = struct.upstreamGates.map(g => mapping[g] || g);
            const rolls = raw.filter(d => (d.Action || "").toUpperCase().includes("ROLL")).map(d => mapping[d.Gate] || d.Gate);
            drawLineChart("#chart-compact", data, ramps, nameMap, displayOrder, ['Start', ...displayOrder, 'Finish'], upMapped, rolls, 4);
            updateFaultAnalysis("#fault-analysis-compact", raw, struct.orderedGates, nameMap);

            // Compact Report Pie Charts
            const agg = masterDataCompact.filter(d => d.Year === sel.year && d.Competition === sel.comp && d.Gender === sel.gen);
            const uniqueFinals = []; const sEntries = new Set();
            agg.filter(d => d.FinalPosition > 0).forEach(d => { const k = `${d.Phase}-${d.BIB}`; if(!sEntries.has(k)) { sEntries.add(k); uniqueFinals.push(d); }});
            const winners = uniqueFinals.filter(d => d.FinalPosition === 1);
            const lLabels = Object.values(bibFullNames).sort();
            const bColScale = d3.scaleOrdinal().domain(lLabels).range(lLabels.map(l => bibColors[Object.keys(bibFullNames).find(k => bibFullNames[k] === l)]));
            
            drawPieChartAndLegend("#pie-chart-bib-compact", "#pie-legend-bib-compact", lLabels.map(l => ({ label: l, value: d3.rollup(winners, v => v.length, d => bibFullNames[d.BIB]).get(l) || 0 })), bColScale);
            drawPieChartAndLegend("#pie-chart-bib-second-compact", "#pie-legend-bib-second-compact", lLabels.map(l => ({ label: l, value: d3.rollup(uniqueFinals.filter(d => d.FinalPosition === 2), v => v.length, d => bibFullNames[d.BIB]).get(l) || 0 })), bColScale);

            const rampWinners = d3.rollup(winners, v => v.length, d => d.RampPosition);
            drawPieChartAndLegend("#pie-chart-ramp-compact", "#pie-legend-ramp-compact", [1,2,3,4].map(p => ({ label: `Ramp ${p}`, value: rampWinners.get(p) || 0 })), d3.scaleOrdinal().range(['#a855f7', '#ec4899', '#f97316', '#84cc16']));
            
            const rampSeconds = d3.rollup(uniqueFinals.filter(d => d.FinalPosition === 2), v => v.length, d => d.RampPosition);
            drawPieChartAndLegend("#pie-chart-ramp-second-compact", "#pie-legend-ramp-second-compact", [1,2,3,4].map(p => ({ label: `Ramp ${p}`, value: rampSeconds.get(p) || 0 })), d3.scaleOrdinal().range(['#a855f7', '#ec4899', '#f97316', '#84cc16']));
        }

        function updateFaultAnalysis(id, raceData, ordered, names) {
            const container = d3.select(id).html("");
            if (!raceData.length) { container.classed("hidden", true); return; }
            const sorted = getCalculatedRaceResults(raceData, ordered);
            const hasF = sorted.some(a => a.faultCount > 0 || a.isRAL);
            container.classed("hidden", false);
            if (!hasF) { container.append("p").attr("class", "text-slate-400 text-sm italic text-center").text("No Faults for this Race."); return; }
            const faultSection = container.append("div").attr("class", "grid grid-cols-1 md:grid-cols-2 gap-6");
            const statusBox = faultSection.append("div").attr("class", "bg-slate-900/50 p-4 rounded-lg border border-slate-700");
            statusBox.append("h4").attr("class", "text-base font-bold text-slate-300 mb-3 border-b border-slate-700 pb-2 uppercase").text("Fault Status");
            [...sorted].sort((a,b) => ['R','G','B','Y'].indexOf(a.bib) - ['R','G','B','Y'].indexOf(b.bib)).forEach(a => {
                const r = statusBox.append("div").attr("class", "flex items-center justify-between text-sm py-1 border-b border-slate-800 last:border-0");
                r.append("div").attr("class", "flex items-center gap-2").html(`<div class="w-3 h-3 rounded-sm" style="background-color:${bibColors[a.bib]}"></div><span class="text-slate-200">${a.name}</span>`);
                r.append("span").attr("class", a.faultCount > 0 ? "text-red-400 font-bold" : "text-slate-500").text(a.faultCount > 0 ? a.faults.join(", ") : "-");
            });
            const rankBox = faultSection.append("div").attr("class", "bg-slate-900/50 p-4 rounded-lg border border-slate-700");
            rankBox.append("h4").attr("class", "text-base font-bold text-slate-300 mb-3 border-b border-slate-700 pb-2 uppercase").text("Updated Phase Result");
            sorted.forEach(a => {
                const r = rankBox.append("div").attr("class", "grid grid-cols-[1.5rem_1rem_1fr_auto] gap-x-3 items-center text-sm py-1 border-b border-slate-800 last:border-0");
                r.append("span").attr("class", `font-mono ${a.calculatedRank===1?'text-yellow-400':'text-slate-300'} text-right`).text(a.calculatedRank);
                r.append("div").attr("class", "w-3 h-3 rounded-sm").style("background-color", bibColors[a.bib]);
                r.append("span").attr("class", "text-slate-200 truncate").text(a.name);
                r.append("span").attr("class", "text-xs text-slate-500 italic").text(a.isRAL ? "RAL" : (a.faultCount > 0 ? `${a.faultCount} Fault(s)` : "Clean"));
            });
        }

        // --- ATHLETE PROFILE LOGIC (RESTORED FULL) ---
        function setupAthleteProfileTab() {
            const unique = {
                year: [...new Set(masterDataCompact.map(d => d.Year))].sort((a,b)=>b-a),
                competition: [...new Set(masterDataCompact.map(d => d.Competition))].sort(),
                gender: [...new Set(masterDataCompact.map(d => d.Gender))].sort(),
            };
            for (const key in selectorsAthlete) {
                selectorsAthlete[key].selectAll("option").data(['All', ...unique[key]]).join("option").attr("value", d => d).text(d => d);
                selectorsAthlete[key].on("change", updateAthleteSelectors);
            }
            d3.selectAll(".athlete-select").on("change", updateAthleteProfiles);
            updateAthleteSelectors();
        }

        function updateAthleteSelectors() {
            const selY = selectorsAthlete.year.property("value");
            const selC = selectorsAthlete.competition.property("value");
            const selG = selectorsAthlete.gender.property("value");
            let data = masterDataCompact;
            if (selY !== 'All') data = data.filter(d => d.Year === +selY);
            if (selC !== 'All') data = data.filter(d => d.Competition === selC);
            if (selG !== 'All') data = data.filter(d => d.Gender === selG);
            const names = ['', ...[...new Set(data.filter(d => d.Gate === 'Ramp' && d.AthleteName).map(d => formatAthleteName(d.AthleteName)))].sort()];
            d3.selectAll(".athlete-select").each(function() {
                const cur = d3.select(this).property("value");
                d3.select(this).selectAll("option").data(names).join("option").attr("value", d => d).text(d => d || "Select Athlete...");
                if (names.includes(cur)) d3.select(this).property("value", cur);
            });
            updateAthleteProfiles();
        }

        function updateAthleteProfiles() {
            const container = d3.select("#athlete-profile-area").html("");
            const selected = [d3.select("#athlete-select-1").property("value"), d3.select("#athlete-select-2").property("value"), d3.select("#athlete-select-3").property("value")].filter(n => n);
            const gridClass = selected.length === 2 ? "md:grid-cols-2" : (selected.length >= 3 ? "md:grid-cols-3" : "grid-cols-1");
            container.attr("class", `mt-8 grid gap-4 items-start ${gridClass}`);
            selected.forEach(name => appendAthleteProfile(name, container, selected.length));
        }

        function appendAthleteProfile(fName, container, count) {
            const sY = selectorsAthlete.year.property("value"), sC = selectorsAthlete.competition.property("value"), sG = selectorsAthlete.gender.property("value");
            let data = masterDataCompact;
            if (sY !== 'All') data = data.filter(d => d.Year === +sY);
            if (sC !== 'All') data = data.filter(d => d.Competition === sC);
            if (sG !== 'All') data = data.filter(d => d.Gender === sG);
            
            const entry = data.find(d => formatAthleteName(d.AthleteName) === fName);
            if (!entry) return;
            const athleteRamps = data.filter(d => d.AthleteName === entry.AthleteName && d.Gate === 'Ramp');
            
            const card = container.append("div").attr("class", "bg-slate-800 rounded-xl shadow-md border border-slate-700 overflow-x-auto w-full");
            card.append("h3").attr("class", "font-bold text-slate-100 p-4 border-b border-slate-700").text(fName);
            const table = card.append("table").attr("class", "w-full text-left text-sm");
            const thead = table.append("thead").attr("class", "bg-slate-700/50 text-xs text-slate-400 uppercase");
            thead.append("tr").selectAll("th").data(['Phase', 'Bib', 'Ramp', 'Tactic']).join("th").attr("class", "p-3").text(d => d);
            const tbody = table.append("tbody");
            athleteRamps.forEach(r => {
                const tr = tbody.append("tr").attr("class", "border-t border-slate-700");
                tr.append("td").attr("class", "p-3").text(r.Phase);
                tr.append("td").attr("class", "p-3").html(`<div class="w-3 h-3 rounded-sm" style="background-color:${bibColors[r.BIB]}"></div>`);
                tr.append("td").attr("class", "p-3").text(r.RampPosition);
                // Contextual tactic
                const fullRace = data.filter(d => d.Phase === r.Phase && d.BIB === r.BIB);
                const tac = fullRace.find(d => d.UpstreamTactic && d.UpstreamTactic.trim() !== '');
                tr.append("td").attr("class", "p-3 text-xs italic").text(tac ? tac.UpstreamTactic : '-');
            });
        }

        // --- SEASON SUMMARY LOGIC (RESTORED FULL) ---
        function setupSeasonSummaryTab() {
            const uniqueYears = [...new Set(masterDataFull.map(d => d.Year))].sort((a,b)=>b-a);
            selectorsSummary.year.selectAll("option").data(uniqueYears).join("option").attr("value", d => d).text(d => d);
            selectorsSummary.year.on("change", updateSummaryAthletes);
            selectorsSummary.athlete.on("change", generateSeasonSummary);
            updateSummaryAthletes();
        }

        function updateSummaryAthletes() {
            const yr = +selectorsSummary.year.property("value");
            const names = [...new Set(masterDataFull.filter(d => d.Year === yr).map(d => formatAthleteName(d.AthleteName)))].filter(n => n).sort();
            selectorsSummary.athlete.html("").append("option").text("Select Athlete...").attr("value", "");
            selectorsSummary.athlete.selectAll("option.val").data(names).join("option").attr("class","val").attr("value", d => d).text(d => d);
            d3.select("#summary-content-area").html("");
        }

        function generateSeasonSummary() {
            const container = d3.select("#summary-content-area").html("");
            const yr = +selectorsSummary.year.property("value"), name = selectorsSummary.athlete.property("value");
            if (!name) return;
            const aData = masterDataFull.filter(d => d.Year === yr && formatAthleteName(d.AthleteName) === name);
            const races = []; const seen = new Set();
            aData.forEach(d => { const k = `${d.Competition}|${d.Phase}|${d.Gender}`; if(!seen.has(k)) { seen.add(k); races.push({ competition: d.Competition, phase: d.Phase, gender: d.Gender }); }});
            
            const table = container.append("div").attr("class", "overflow-x-auto bg-slate-800 rounded-xl border border-slate-700")
                .append("table").attr("class", "w-full text-left text-sm text-slate-300");
            const thead = table.append("thead").attr("class", "bg-slate-700/50 uppercase text-xs text-slate-400");
            thead.append("tr").selectAll("th").data(["Competition", "Phase", "Bib", "Ramp", "Phase Rank", "Finish Rank", "Notes"]).join("th").attr("class", "p-3").text(d => d);
            const tbody = table.append("tbody");
            
            races.forEach(r => {
                const fullRace = masterDataFull.filter(d => d.Year === yr && d.Competition === r.competition && d.Phase === r.phase && d.Gender === r.gender);
                const struct = scanCompetitionStructure(yr, r.competition, masterDataFull);
                const ranked = getCalculatedRaceResults(fullRace, struct.orderedGates);
                const res = ranked.find(x => x.name === name);
                if (res) {
                    const tr = tbody.append("tr").attr("class", "border-t border-slate-700 hover:bg-slate-700/30");
                    tr.append("td").attr("class", "p-3 font-medium text-white").text(r.competition);
                    tr.append("td").attr("class", "p-3").text(r.phase);
                    tr.append("td").attr("class", "p-3").html(`<div class="w-3 h-3 rounded-sm inline-block mr-2" style="background-color:${bibColors[res.bib]}"></div>${res.bib}`);
                    tr.append("td").attr("class", "p-3").text(res.rampPosition);
                    tr.append("td").attr("class", "p-3 font-mono font-bold text-white").text(res.calculatedRank);
                    const fCell = tr.append("td").attr("class", "p-3 font-mono font-bold");
                    const fVal = parseInt(res.finishRank);
                    if (!isNaN(fVal)) {
                        fCell.style("color", fVal === 1 ? medalColors.gold : (fVal === 2 ? medalColors.silver : (fVal === 3 ? medalColors.bronze : "#fff"))).text(fVal);
                    } else fCell.text("-");
                    tr.append("td").attr("class", "p-3 text-slate-500 italic").text(res.isRAL ? "RAL" : (res.faultCount > 0 ? `${res.faultCount} FLT` : "-"));
                }
            });
        }

        // --- FILTER HELPERS & LOADER ---
        function populateFilters(data, group) {
            const unique = {
                year: [...new Set(data.map(d => d.Year))].sort((a, b) => b - a),
                competition: [...new Set(data.map(d => d.Competition))].sort(),
                gender: [...new Set(data.map(d => d.Gender))].sort(),
                phase: [...new Set(data.map(d => d.Phase))]
            };
            const phaseOrder = { 'R': 1, 'Rep': 2, 'H': 3, 'QF': 4, 'SF': 5, 'Final': 6 };
            unique.phase.sort((a, b) => {
                const mA = a.match(/^([A-Za-z]+)(\d*)$/) || [a,a,''], mB = b.match(/^([A-Za-z]+)(\d*)$/) || [b,b,''];
                const oA = phaseOrder[mA[1] === 'Final' ? 'Final' : mA[1]] || 99, oB = phaseOrder[mB[1] === 'Final' ? 'Final' : mB[1]] || 99;
                return oA !== oB ? oA - oB : parseInt(mA[2] || '0') - parseInt(mB[2] || '0');
            });
            for (const key in group) {
                const opts = key === 'year' ? unique[key] : ['All', ...unique[key]];
                group[key].selectAll("option").data(opts).join("option").attr("value", d => d).text(d => d);
                group[key].on("change", group === selectorsFull ? updateAllChartsFull : updateAllChartsCompact);
            }
        }

        function forceDefaults(group, data) {
            const latest = d3.max(data, d => d.Year);
            if (latest) group.year.property("value", latest);
            const comps = [...new Set(data.filter(d => d.Year === latest).map(d => d.Competition))].sort();
            if (comps.length) group.competition.property("value", comps[0]);
            group.gender.property("value", [...new Set(data.map(d => d.Gender))].includes("Men") ? "Men" : "Women");
            group.phase.property("value", [...new Set(data.map(d => d.Phase))].includes("Final") ? "Final" : "R1");
        }

        async function loadInitialData() {
            tooltip = d3.select(".tooltip");
            tabFull = d3.select("#tab-full"); tabCompact = d3.select("#tab-compact"); tabAthlete = d3.select("#tab-athlete"); tabSummary = d3.select("#tab-summary");
            reportFull = d3.select("#report-full"); reportCompact = d3.select("#report-compact"); reportAthlete = d3.select("#report-athlete"); reportSummary = d3.select("#report-summary");
            lastUpdatedEl = d3.select("#last-updated");
            selectorsFull = { year: d3.select("#year-select-full"), competition: d3.select("#competition-select-full"), gender: d3.select("#gender-select-full"), phase: d3.select("#phase-select-full") };
            filterControlsFull = d3.select("#filter-controls-full");
            selectorsCompact = { year: d3.select("#year-select-compact"), competition: d3.select("#competition-select-compact"), gender: d3.select("#gender-select-compact"), phase: d3.select("#phase-select-compact") };
            filterControlsCompact = d3.select("#filter-controls-compact");
            selectorsAthlete = { year: d3.select("#year-select-athlete"), competition: d3.select("#competition-select-athlete"), gender: d3.select("#gender-select-athlete") };
            selectorsSummary = { year: d3.select("#year-select-summary"), athlete: d3.select("#athlete-select-summary") };

            lastUpdatedEl.html(`<span class="w-1.5 h-1.5 rounded-full bg-green-500 live-indicator"></span> Refreshing...`);
            try {
                const cb = Date.now();
                const [rF, rC] = await Promise.all([
                    fetch(`https://raw.githubusercontent.com/katrina-sutherland/kx_tagger/main/data/kx_race_analysis_git.csv?t=${cb}`),
                    fetch(`https://raw.githubusercontent.com/katrina-sutherland/kx_tagger/main/data/Kayak_Cross_Data_IN_COMPETITION.csv?t=${cb}`)
                ]);
                masterDataFull = parseCsvData(await rF.text());
                masterDataCompact = parseCsvData(await rC.text());

                if (masterDataFull.length) { filterControlsFull.classed("hidden", false); populateFilters(masterDataFull, selectorsFull); forceDefaults(selectorsFull, masterDataFull); updateAllChartsFull(); setupSeasonSummaryTab(); }
                if (masterDataCompact.length) { filterControlsCompact.classed("hidden", false); populateFilters(masterDataCompact, selectorsCompact); forceDefaults(selectorsCompact, masterDataCompact); updateAllChartsCompact(); setupAthleteProfileTab(); }

                lastUpdatedEl.html(`<span class="w-1.5 h-1.5 rounded-full bg-green-500"></span> Last Updated: ${new Date().toLocaleTimeString()}`);
                tabFull.on("click", () => { setActiveTab(tabFull); updateAllChartsFull(); });
                tabCompact.on("click", () => { setActiveTab(tabCompact); updateAllChartsCompact(); });
                tabAthlete.on("click", () => setActiveTab(tabAthlete));
                tabSummary.on("click", () => setActiveTab(tabSummary));
                window.addEventListener('resize', () => { if (!reportFull.classed('hidden')) updateAllChartsFull(); if (!reportCompact.classed('hidden')) updateAllChartsCompact(); });
            } catch (e) { lastUpdatedEl.html(`<span class="w-1.5 h-1.5 rounded-full bg-red-500"></span> Error loading data.`); }
        }

        document.addEventListener('DOMContentLoaded', loadInitialData);
    </script>
</body>

</html>
