<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kayak Cross Race Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .x-axis path,
        .y-axis path {
            display: none;
        }

        .x-axis .tick line,
        .y-axis .tick line {
            stroke: #334155;
            stroke-dasharray: 2, 2;
        }

        .x-axis .tick text {
            fill: #94a3b8;
            font-size: 12px;
            font-weight: 600;
        }

        .y-axis .tick text {
            fill: #94a3b8;
            font-size: 14px;
            font-weight: 700;
        }

        .domain {
            display: none;
        }

        .dark-select,
        .dark-input {
            background-color: #1e293b;
            border-color: #475569;
            color: #e2e8f0;
        }

        .tooltip {
            position: absolute;
            text-align: left;
            padding: 8px;
            font: 12px sans-serif;
            background: #1e293b;
            color: white;
            border: 1px solid #334155;
            border-radius: 8px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 50;
        }

        .chart-card {
            transition: border-color 0.3s ease-in-out;
        }

        @keyframes pulse-green {
            0% {
                box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7);
            }

            70% {
                box-shadow: 0 0 0 6px rgba(34, 197, 94, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(34, 197, 94, 0);
            }
        }

        .live-indicator {
            animation: pulse-green 2s infinite;
        }
    </style>
</head>

<body class="bg-slate-900 text-slate-200 antialiased">
    <div class="tooltip"></div>
    <div class="container mx-auto p-4 md:p-8">
        <header class="flex flex-col lg:flex-row justify-between items-center mb-8 relative">
            <div class="w-full text-center lg:absolute lg:left-0 lg:right-0 pointer-events-none mb-2 lg:mb-0">
                <h1 class="text-3xl font-bold text-slate-100 pointer-events-auto inline-block">Kayak Cross Analysis</h1>
            </div>
            <div id="last-updated"
                class="lg:ml-auto text-[10px] md:text-xs text-slate-500 font-mono z-10 relative flex items-center gap-2 max-w-md text-right overflow-hidden whitespace-nowrap text-ellipsis">
            </div>
        </header>

        <div class="max-w-7xl mx-auto mb-8 border-b border-slate-700">
            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                <button id="tab-full"
                    class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-indigo-400 border-indigo-500">
                    Full Report
                </button>
                <button id="tab-compact"
                    class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-slate-400 border-transparent hover:text-slate-300 hover:border-slate-500">
                    In-Competition Report
                </button>
                <button id="tab-athlete"
                    class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-slate-400 border-transparent hover:text-slate-300 hover:border-slate-500">
                    Athlete Profile
                </button>
                <button id="tab-summary"
                    class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-slate-400 border-transparent hover:text-slate-300 hover:border-slate-500">
                    Season Summary
                </button>
            </nav>
        </div>

        <!-- FULL REPORT CONTAINER -->
        <div id="report-full">
            <div class="max-w-7xl mx-auto space-y-8">
                <div id="filter-controls-full"
                    class="bg-slate-800 p-4 rounded-xl shadow-md border border-slate-700 mb-8 hidden">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div>
                            <label for="year-select-full"
                                class="block text-sm font-medium text-slate-300 mb-1">Year</label>
                            <select id="year-select-full"
                                class="dark-select w-full rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></select>
                        </div>
                        <div>
                            <label for="competition-select-full"
                                class="block text-sm font-medium text-slate-300 mb-1">Competition</label>
                            <select id="competition-select-full"
                                class="dark-select w-full rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></select>
                        </div>
                        <div>
                            <label for="gender-select-full"
                                class="block text-sm font-medium text-slate-300 mb-1">Gender</label>
                            <select id="gender-select-full"
                                class="dark-select w-full rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></select>
                        </div>
                        <div>
                            <label for="phase-select-full"
                                class="block text-sm font-medium text-slate-300 mb-1">Phase</label>
                            <select id="phase-select-full"
                                class="dark-select w-full rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></select>
                        </div>
                    </div>
                </div>
            </div>
            <div id="charts-area-full" class="max-w-7xl mx-auto mt-8 grid grid-cols-1 lg:grid-cols-5 gap-8 items-start">
                <div class="lg:col-span-3 flex flex-col gap-8">
                    <div class="bg-slate-800 p-4 sm:p-6 rounded-xl shadow-md border border-slate-700 chart-card">
                        <h3 class="text-xl font-semibold text-slate-100 mb-4 text-center">CLSX Head to Head Race
                            Analysis</h3>
                        <div id="legend-full" class="flex justify-center space-x-4 mb-4"></div>
                        <div id="chart-container-full" class="w-full h-[600px]">
                            <svg id="chart-full" class="w-full h-full"></svg>
                        </div>
                    </div>
                    <div id="fault-analysis-full"
                        class="bg-slate-800 p-4 sm:p-6 rounded-xl shadow-md border border-slate-700 hidden"></div>
                </div>

                <div class="lg:col-span-2 grid grid-cols-2 gap-4">
                    <div class="bg-slate-800 p-2 sm:p-4 rounded-xl shadow-md border border-slate-700 chart-card">
                        <h3 class="text-sm font-semibold text-slate-100 mb-4 text-center leading-tight">Overall Win % by
                            Bib Color</h3>
                        <div id="pie-chart-bib-full" class="w-full h-40 flex items-center justify-center"></div>
                        <div id="pie-legend-bib-full" class="flex flex-col items-center gap-y-2 mt-4"></div>
                    </div>
                    <div class="bg-slate-800 p-2 sm:p-4 rounded-xl shadow-md border border-slate-700 chart-card">
                        <h3 class="text-sm font-semibold text-slate-100 mb-4 text-center leading-tight">Overall 2nd
                            Place % by Bib Color</h3>
                        <div id="pie-chart-bib-second-full" class="w-full h-40 flex items-center justify-center"></div>
                        <div id="pie-legend-bib-second-full" class="flex flex-col items-center gap-y-2 mt-4"></div>
                    </div>
                    <div class="bg-slate-800 p-2 sm:p-4 rounded-xl shadow-md border border-slate-700 chart-card">
                        <h3 class="text-sm font-semibold text-slate-100 mb-4 text-center leading-tight">Finish Position
                            % when Leading at 1st Upstream</h3>
                        <div id="pie-chart-gate2-full" class="w-full h-40 flex items-center justify-center"></div>
                        <div id="pie-legend-gate2-full" class="flex flex-col items-center gap-y-2 mt-4"></div>
                    </div>
                    <div class="bg-slate-800 p-2 sm:p-4 rounded-xl shadow-md border border-slate-700 chart-card">
                        <h3 class="text-sm font-semibold text-slate-100 mb-4 text-center leading-tight">Rank at 1st
                            Upstream When Overall Finish 2nd</h3>
                        <div id="pie-chart-gate2-second-full" class="w-full h-40 flex items-center justify-center">
                        </div>
                        <div id="pie-legend-gate2-second-full" class="flex flex-col items-center gap-y-2 mt-4"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- COMPACT / IN-COMPETITION REPORT CONTAINER -->
        <div id="report-compact" class="hidden">
            <div class="max-w-7xl mx-auto space-y-8">
                <div id="filter-controls-compact"
                    class="bg-slate-800 p-4 rounded-xl shadow-md border border-slate-700 mb-8 hidden">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div>
                            <label for="year-select-compact"
                                class="block text-sm font-medium text-slate-300 mb-1">Year</label>
                            <select id="year-select-compact"
                                class="dark-select w-full rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></select>
                        </div>
                        <div>
                            <label for="competition-select-compact"
                                class="block text-sm font-medium text-slate-300 mb-1">Competition</label>
                            <select id="competition-select-compact"
                                class="dark-select w-full rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></select>
                        </div>
                        <div>
                            <label for="gender-select-compact"
                                class="block text-sm font-medium text-slate-300 mb-1">Gender</label>
                            <select id="gender-select-compact"
                                class="dark-select w-full rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></select>
                        </div>
                        <div>
                            <label for="phase-select-compact"
                                class="block text-sm font-medium text-slate-300 mb-1">Phase</label>
                            <select id="phase-select-compact"
                                class="dark-select w-full rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></select>
                        </div>
                    </div>
                </div>
            </div>
            <div id="charts-area-compact"
                class="max-w-7xl mx-auto mt-8 grid grid-cols-1 lg:grid-cols-5 gap-8 items-start">
                <div class="lg:col-span-3 flex flex-col gap-8">
                    <div class="bg-slate-800 p-4 sm:p-6 rounded-xl shadow-md border border-slate-700 chart-card">
                        <h3 class="text-xl font-semibold text-slate-100 mb-4 text-center">CLSX Head to Head Race
                            Analysis</h3>
                        <div id="legend-compact" class="flex justify-center space-x-4 mb-4"></div>
                        <div id="chart-container-compact" class="w-full h-[600px]">
                            <svg id="chart-compact" class="w-full h-full"></svg>
                        </div>
                    </div>
                    <div id="fault-analysis-compact"
                        class="bg-slate-800 p-4 sm:p-6 rounded-xl shadow-md border border-slate-700 hidden"></div>
                </div>

                <div class="lg:col-span-2 grid grid-cols-2 gap-4">
                    <div
                        class="bg-slate-800 p-2 sm:p-4 rounded-xl shadow-md border border-slate-700 chart-card flex flex-col justify-center">
                        <h3 class="text-xs font-semibold text-slate-100 mb-4 text-center leading-tight">Overall Win
                            %<br>by Bib Color</h3>
                        <div id="pie-chart-bib-compact" class="w-full h-32 flex items-center justify-center"></div>
                        <div id="pie-legend-bib-compact" class="flex flex-col items-center gap-y-1 mt-2"></div>
                    </div>
                    <div
                        class="bg-slate-800 p-2 sm:p-4 rounded-xl shadow-md border border-slate-700 chart-card flex flex-col justify-center">
                        <h3 class="text-xs font-semibold text-slate-100 mb-4 text-center leading-tight">Overall 2nd
                            Place %<br>by Bib Color</h3>
                        <div id="pie-chart-bib-second-compact" class="w-full h-32 flex items-center justify-center">
                        </div>
                        <div id="pie-legend-bib-second-compact" class="flex flex-col items-center gap-y-1 mt-2"></div>
                    </div>
                    <div
                        class="bg-slate-800 p-2 sm:p-4 rounded-xl shadow-md border border-slate-700 chart-card flex flex-col justify-center">
                        <h3 class="text-xs font-semibold text-slate-100 mb-4 text-center leading-tight">Win %<br>by Ramp
                            Position</h3>
                        <div id="pie-chart-ramp-compact" class="w-full h-32 flex items-center justify-center"></div>
                        <div id="pie-legend-ramp-compact" class="flex flex-col items-center gap-y-1 mt-2"></div>
                    </div>
                    <div
                        class="bg-slate-800 p-2 sm:p-4 rounded-xl shadow-md border border-slate-700 chart-card flex flex-col justify-center">
                        <h3 class="text-xs font-semibold text-slate-100 mb-4 text-center leading-tight">2nd Place
                            %<br>by Ramp Position</h3>
                        <div id="pie-chart-ramp-second-compact" class="w-full h-32 flex items-center justify-center">
                        </div>
                        <div id="pie-legend-ramp-second-compact" class="flex flex-col items-center gap-y-1 mt-2"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ATHLETE PROFILE CONTAINER -->
        <div id="report-athlete" class="hidden">
            <div class="max-w-7xl mx-auto space-y-8">
                <div id="athlete-search-controls"
                    class="bg-slate-800 p-6 rounded-xl shadow-md border border-slate-700 space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label for="year-select-athlete"
                                class="block text-sm font-medium text-slate-300 mb-2">Year</label>
                            <select id="year-select-athlete"
                                class="dark-select w-full rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></select>
                        </div>
                        <div>
                            <label for="competition-select-athlete"
                                class="block text-sm font-medium text-slate-300 mb-2">Competition</label>
                            <select id="competition-select-athlete"
                                class="dark-select w-full rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></select>
                        </div>
                        <div>
                            <label for="gender-select-athlete"
                                class="block text-sm font-medium text-slate-300 mb-2">Gender</label>
                            <select id="gender-select-athlete"
                                class="dark-select w-full rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 border-t border-slate-700 pt-6">
                        <div>
                            <label for="athlete-select-1" class="block text-sm font-medium text-slate-300 mb-2">Athlete
                                1</label>
                            <select id="athlete-select-1"
                                class="athlete-select dark-select w-full rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></select>
                        </div>
                        <div>
                            <label for="athlete-select-2" class="block text-sm font-medium text-slate-300 mb-2">Athlete
                                2</label>
                            <select id="athlete-select-2"
                                class="athlete-select dark-select w-full rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></select>
                        </div>
                        <div>
                            <label for="athlete-select-3" class="block text-sm font-medium text-slate-300 mb-2">Athlete
                                3</label>
                            <select id="athlete-select-3"
                                class="athlete-select dark-select w-full rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></select>
                        </div>
                    </div>
                </div>
                <div id="athlete-profile-area" class="mt-8">
                </div>
            </div>
        </div>

        <!-- SEASON SUMMARY CONTAINER -->
        <div id="report-summary" class="hidden">
            <div class="max-w-7xl mx-auto space-y-8">
                <div class="bg-slate-800 p-6 rounded-xl shadow-md border border-slate-700">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="year-select-summary"
                                class="block text-sm font-medium text-slate-300 mb-2">Year</label>
                            <select id="year-select-summary"
                                class="dark-select w-full rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></select>
                        </div>
                        <div>
                            <label for="athlete-select-summary"
                                class="block text-sm font-medium text-slate-300 mb-2">Athlete</label>
                            <select id="athlete-select-summary"
                                class="dark-select w-full rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></select>
                        </div>
                    </div>
                </div>

                <div id="summary-content-area" class="mt-8">
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DATA STATE & CONSTANTS ---
        let masterDataFull = [];
        let masterDataCompact = [];
        const bibColors = { 'r': '#ef4444', 'g': '#22c55e', 'b': '#3b82f6', 'y': '#eab308', 'R': '#ef4444', 'G': '#22c55e', 'B': '#3b82f6', 'Y': '#eab308' };
        const bibFullNames = { 'R': 'RED', 'G': 'GREEN', 'B': 'BLUE', 'Y': 'YELLOW' };
        const medalColors = { gold: '#D4AF37', silver: '#C0C0C0', bronze: '#A97142' };

        // Declare DOM variables
        let tooltip, tabFull, tabCompact, tabAthlete, tabSummary;
        let reportFull, reportCompact, reportAthlete, reportSummary, lastUpdatedEl;
        let selectorsFull, filterControlsFull, selectorsCompact, filterControlsCompact, selectorsAthlete, selectorsSummary;

        // --- TAB HANDLING ---
        function setActiveTab(activeTab) {
            const tabs = [tabFull, tabCompact, tabAthlete, tabSummary];
            const reports = [reportFull, reportCompact, reportAthlete, reportSummary];

            tabs.forEach(tab => {
                const isActive = tab.node() === activeTab.node();
                tab.classed("text-indigo-400 border-indigo-500", isActive)
                    .classed("text-slate-400 border-transparent", !isActive);
            });

            reports.forEach((report, index) => {
                report.classed("hidden", tabs[index].node() !== activeTab.node());
            });
        }

        // --- CORE HELPERS ---
        function formatAthleteName(name) {
            if (!name || typeof name !== 'string') return '';
            const parts = name.trim().split(/\s+/);
            if (parts.length >= 2) {
                const lastName = parts[0].toUpperCase();
                const firstName = parts.slice(1).map(part => part.charAt(0).toUpperCase() + part.slice(1).toLowerCase()).join(' ');
                return `${lastName} ${firstName}`;
            }
            return name.toUpperCase();
        }

        // Helper to show messages in chart areas
        function showInitialMessage(containerSelector, message) {
            const svg = d3.select(containerSelector);
            if (svg.empty()) return;
            svg.selectAll("*").remove();

            const container = svg.node().parentNode;
            const width = container.clientWidth || 800;
            const height = container.clientHeight || 600;

            svg.append("text")
                .attr("x", width / 2)
                .attr("y", height / 2)
                .attr("text-anchor", "middle")
                .attr("dominant-baseline", "middle")
                .attr("class", "text-slate-500 text-lg select-none")
                .style("fill", "#94a3b8")
                .text(message);
        }

        function getGateColor(gate, upstreamGates, rollGates) {
            const g = String(gate).toUpperCase();
            if (g === 'START' || g === 'FINISH' || g === 'RAMP') return '#475569';
            if (rollGates.includes(gate) || g.includes('ROLL')) return '#a855f7'; 
            if (upstreamGates.includes(gate) || g.includes('UP')) return '#ef4444';
            return '#334155';
        }

        // --- DATA PARSING ---
        function parseCsvData(csvString) {
            return d3.csvParse(csvString, (d) => {
                for (let key in d) {
                    if (d[key] && typeof d[key] === 'string') d[key] = d[key].trim();
                }

                const year = +d.Year || 0;
                const competition = d.Competition || '';
                const gender = d.Gender || '';
                const phase = d.Phase || '';

                let gate = d.Gate || '';
                if (gate.startsWith('Gate ')) gate = gate.replace('Gate ', '');
                else if (gate === 'Course') gate = 'Roll';

                const bib = d.BIB || d.Bib || '';
                const position = +(d.Order || d.Position || 0);
                const rampPosition = +(d['Ramp Position'] || d['RampPosition'] || 0);
                const finalPosition = +(d['Final Position'] || d['FinalPosition'] || 0);
                const upstreamTactic = d['Upstream Tactic'] || d['UpstreamTactic'] || '';

                const athleteName = d['Athlete Name'] || d['Athlete'] || d['Name'] || '';
                const action = d.Action || d.action || d.Notes || d.notes || '';
                const faultVal = d.Fault || d.fault || '';
                const finishRank = d['Finish Rank'] || d['FinishRank'] || d.Rank || d.rank || d['Overall Rank'] || d['OverallRank'] || '';

                return {
                    Year: year, Competition: competition, Gender: gender, Phase: phase, Gate: gate,
                    BIB: bib, Position: position, RampPosition: rampPosition, FinalPosition: finalPosition,
                    UpstreamTactic: upstreamTactic, AthleteName: athleteName, Action: action, FaultVal: faultVal, FinishRank: finishRank
                };
            });
        }

        // --- GLOBAL COMPETITION SCANNER ---
        function scanCompetitionStructure(year, competition, allData) {
            const compData = allData.filter(d => {
                return (year === 'All' || d.Year === year) && 
                       (competition === 'All' || d.Competition === competition);
            });
            
            if (compData.length === 0) return { orderedGates: ['1', '2', '3', '4', '5', '6', 'Roll', '7', '8'], upstreamGates: ['2', '8'] };

            const detectedUpstreams = new Set();
            compData.forEach(d => {
                const action = (d.Action || "").toUpperCase();
                const tactic = (d.UpstreamTactic || "").toUpperCase();
                if (action.includes('UP') || tactic.trim().length > 0) detectedUpstreams.add(d.Gate);
            });

            const runs = {};
            compData.forEach(d => {
                const runId = `${d.Phase}-${d.Gender}-${d.BIB}`;
                if (!runs[runId]) runs[runId] = [];
                if (d.Gate && !['Start', 'Finish', 'Ramp'].includes(d.Gate)) runs[runId].push(d.Gate);
            });

            let longestSequence = [];
            Object.values(runs).forEach(seq => { if (seq.length > longestSequence.length) longestSequence = seq; });
            const finalOrder = [...new Set(longestSequence)];

            if (finalOrder.length === 0) {
                const uniqueGates = [...new Set(compData.map(d => d.Gate))].filter(g => g && !['Start', 'Finish', 'Ramp'].includes(g));
                uniqueGates.sort((a, b) => { if (a === 'Roll') return 0; return parseInt(a) - parseInt(b); });
                return { orderedGates: uniqueGates, upstreamGates: Array.from(detectedUpstreams) };
            }
            return { orderedGates: finalOrder, upstreamGates: Array.from(detectedUpstreams) };
        }

        // --- INITIALIZATION ---
        async function loadInitialData() {
            tooltip = d3.select(".tooltip");
            tabFull = d3.select("#tab-full");
            tabCompact = d3.select("#tab-compact");
            tabAthlete = d3.select("#tab-athlete");
            tabSummary = d3.select("#tab-summary");
            reportFull = d3.select("#report-full");
            reportCompact = d3.select("#report-compact");
            reportAthlete = d3.select("#report-athlete");
            reportSummary = d3.select("#report-summary");
            lastUpdatedEl = d3.select("#last-updated");

            selectorsFull = {
                year: d3.select("#year-select-full"),
                competition: d3.select("#competition-select-full"),
                gender: d3.select("#gender-select-full"),
                phase: d3.select("#phase-select-full")
            };
            selectorsCompact = {
                year: d3.select("#year-select-compact"),
                competition: d3.select("#competition-select-compact"),
                gender: d3.select("#gender-select-compact"),
                phase: d3.select("#phase-select-compact")
            };
            selectorsAthlete = {
                year: d3.select("#year-select-athlete"),
                competition: d3.select("#competition-select-athlete"),
                gender: d3.select("#gender-select-athlete")
            };
            selectorsSummary = {
                year: d3.select("#year-select-summary"),
                athlete: d3.select("#athlete-select-summary")
            };

            const now = new Date();
            lastUpdatedEl.html(`<span class="w-1.5 h-1.5 rounded-full bg-green-500 live-indicator"></span> Refreshing...`);
            const cacheBuster = now.getTime();

            try {
                const urlFull = `https://raw.githubusercontent.com/katrina-sutherland/kx_tagger/main/data/kx_race_analysis_git.csv?t=${cacheBuster}`;
                const urlCompact = `https://raw.githubusercontent.com/katrina-sutherland/kx_tagger/main/data/Kayak_Cross_Data_IN_COMPETITION.csv?t=${cacheBuster}`;

                const [responseFull, responseCompact] = await Promise.all([fetch(urlFull), fetch(urlCompact)]);
                if (!responseFull.ok || !responseCompact.ok) throw new Error(`Failed to load CSV files`);

                masterDataFull = parseCsvData(await responseFull.text());
                masterDataCompact = parseCsvData(await responseCompact.text());

                console.log(`Successfully loaded masterDataFull: ${masterDataFull.length} rows`);
                console.log(`Successfully loaded masterDataCompact: ${masterDataCompact.length} rows`);

                if (masterDataFull.length > 0) {
                    d3.select("#filter-controls-full").classed("hidden", false);
                    populateFilters(masterDataFull, selectorsFull);
                    forceDefaults(selectorsFull, masterDataFull);
                    updateAllChartsFull();
                    setupSeasonSummaryTab();
                }

                if (masterDataCompact.length > 0) {
                    d3.select("#filter-controls-compact").classed("hidden", false);
                    populateFilters(masterDataCompact, selectorsCompact);
                    forceDefaults(selectorsCompact, masterDataCompact);
                    updateAllChartsCompact();
                    setupAthleteProfileTab();
                }

                lastUpdatedEl.html(`<span class="w-1.5 h-1.5 rounded-full bg-green-500"></span> Last Updated: ${now.toLocaleTimeString()}`);

                tabFull.on("click", () => { setActiveTab(tabFull); if (masterDataFull.length > 0) updateAllChartsFull(); });
                tabCompact.on("click", () => { setActiveTab(tabCompact); if (masterDataCompact.length > 0) updateAllChartsCompact(); });
                tabAthlete.on("click", () => setActiveTab(tabAthlete));
                tabSummary.on("click", () => setActiveTab(tabSummary));

                window.addEventListener('resize', () => {
                    if (!reportFull.classed('hidden')) updateAllChartsFull();
                    if (!reportCompact.classed('hidden')) updateAllChartsCompact();
                });

            } catch (error) {
                console.error('CSV Loading Error:', error);
                lastUpdatedEl.html(`<span class="w-1.5 h-1.5 rounded-full bg-red-500"></span> Error loading data.`);
            }
        }

        function populateFilters(data, selectorGroup) {
            const uniqueValues = {
                year: [...new Set(data.map(d => d.Year))].sort((a, b) => b - a),
                competition: [...new Set(data.map(d => d.Competition))].sort(),
                gender: [...new Set(data.map(d => d.Gender))].sort(),
                phase: [...new Set(data.map(d => d.Phase))]
            };
            const phaseSortOrder = { 'R': 1, 'Rep': 2, 'H': 3, 'QF': 4, 'SF': 5, 'Final': 6 };
            uniqueValues.phase.sort((a, b) => {
                const matchA = a.match(/^([A-Za-z]+)(\d*)$/) || [a, a, ''];
                const matchB = b.match(/^([A-Za-z]+)(\d*)$/) || [b, b, ''];
                const orderA = phaseSortOrder[matchA[1] === 'Final' ? 'Final' : matchA[1]] || 99;
                const orderB = phaseSortOrder[matchB[1] === 'Final' ? 'Final' : matchB[1]] || 99;
                return orderA !== orderB ? orderA - orderB : parseInt(matchA[2] || '0') - parseInt(matchB[2] || '0');
            });
            for (const key in selectorGroup) {
                const options = key === 'year' ? uniqueValues[key] : ['All', ...uniqueValues[key]];
                selectorGroup[key].selectAll("option").data(options).join("option").attr("value", d => d).text(d => d);
                selectorGroup[key].on("change", selectorGroup === selectorsFull ? updateAllChartsFull : updateAllChartsCompact);
            }
        }

        function forceDefaults(selectorGroup, data) {
            const latestYear = d3.max(data, d => d.Year);
            if (latestYear) selectorGroup.year.property("value", latestYear);
            const compsInYear = [...new Set(data.filter(d => d.Year === latestYear).map(d => d.Competition))].sort();
            if (compsInYear.length > 0) selectorGroup.competition.property("value", compsInYear[0]);
            const genders = [...new Set(data.map(d => d.Gender))];
            selectorGroup.gender.property("value", genders.includes("Men") ? "Men" : genders[0]);
            const phases = [...new Set(data.map(d => d.Phase))];
            selectorGroup.phase.property("value", phases.includes("Final") ? "Final" : phases[0]);
        }

        // --- ATHLETE PROFILE ---
        function setupAthleteProfileTab() {
            const uniqueValues = {
                year: [...new Set(masterDataCompact.map(d => d.Year))].sort((a, b) => b - a),
                competition: [...new Set(masterDataCompact.map(d => d.Competition))].sort(),
                gender: [...new Set(masterDataCompact.map(d => d.Gender))].sort(),
            };
            for (const key in selectorsAthlete) {
                selectorsAthlete[key].selectAll("option").data(['All', ...uniqueValues[key]]).join("option").attr("value", d => d).text(d => d);
            }
            Object.values(selectorsAthlete).forEach(sel => sel.on("change", updateAthleteSelectors));
            d3.selectAll(".athlete-select").on("change", updateAthleteProfiles);
            updateAthleteSelectors();
        }

        function updateAthleteSelectors() {
            const selected = { year: selectorsAthlete.year.property("value"), competition: selectorsAthlete.competition.property("value"), gender: selectorsAthlete.gender.property("value") };
            let filteredData = masterDataCompact;
            if (selected.year !== 'All') filteredData = filteredData.filter(d => d.Year === +selected.year);
            if (selected.competition !== 'All') filteredData = filteredData.filter(d => d.Competition === selected.competition);
            if (selected.gender !== 'All') filteredData = filteredData.filter(d => d.Gender === selected.gender);

            const uniqueAthleteNames = ['', ...[...new Set(filteredData.filter(d => d.Gate === 'Ramp' && d.AthleteName).map(d => formatAthleteName(d.AthleteName)))].sort()];
            d3.selectAll(".athlete-select").each(function () {
                const prev = d3.select(this).property("value");
                d3.select(this).selectAll("option").data(uniqueAthleteNames).join("option").attr("value", d => d).text(d => d || "Select Athlete...");
                if (uniqueAthleteNames.includes(prev)) d3.select(this).property("value", prev);
            });
            updateAthleteProfiles();
        }

        function updateAthleteProfiles() {
            const main = d3.select("#athlete-profile-area").html("");
            const selected = [d3.select("#athlete-select-1").property("value"), d3.select("#athlete-select-2").property("value"), d3.select("#athlete-select-3").property("value")].filter(n => n);
            const count = selected.length;
            main.attr("class", `mt-8 grid gap-4 items-start ${count === 2 ? 'grid-cols-1 md:grid-cols-2' : count >= 3 ? 'grid-cols-1 md:grid-cols-3' : 'grid-cols-1'}`);
            selected.forEach(name => appendAthleteProfile(name, main, count));
        }

        function appendAthleteProfile(name, container, totalCount) {
            const year = selectorsAthlete.year.property("value"), comp = selectorsAthlete.competition.property("value"), gender = selectorsAthlete.gender.property("value");
            let data = masterDataCompact;
            if (year !== 'All') data = data.filter(d => d.Year === +year);
            if (comp !== 'All') data = data.filter(d => d.Competition === comp);
            if (gender !== 'All') data = data.filter(d => d.Gender === gender);

            const athleteEntry = data.find(d => formatAthleteName(d.AthleteName) === name);
            if (!athleteEntry) return;

            const runs = data.filter(d => d.AthleteName === athleteEntry.AthleteName && d.Gate === 'Ramp');
            const profileData = runs.map(run => {
                const race = data.filter(d => d.Phase === run.Phase && d.BIB === run.BIB);
                const up = race.find(d => !['Ramp', 'Start', 'Finish'].includes(d.Gate) && d.UpstreamTactic?.trim());
                return { phase: run.Phase, bib: run.BIB, ramp: run.RampPosition, dir: up?.Action || 'N/A', tactic: up?.UpstreamTactic || 'N/A' };
            });

            const isCompact = totalCount >= 3;
            const card = container.append("div").attr("class", "bg-slate-800 rounded-xl border border-slate-700 overflow-hidden");
            card.append("h3").attr("class", `font-bold text-slate-100 border-b border-slate-700 ${isCompact ? 'p-2 text-sm' : 'p-4 text-lg'}`).text(name);
            const table = card.append("table").attr("class", `w-full text-left ${isCompact ? 'text-[10px]' : 'text-sm'}`);
            const thead = table.append("thead").attr("class", "bg-slate-700/50");
            thead.append("tr").selectAll("th").data(['Phase', 'Bib', 'Ramp', 'Dir', 'Tactic']).join("th").attr("class", "p-2 font-semibold text-slate-300").text(d => d);
            const tbody = table.append("tbody");
            profileData.forEach(d => {
                const tr = tbody.append("tr").attr("class", "border-t border-slate-700");
                tr.append("td").attr("class", "p-2").text(d.phase);
                tr.append("td").attr("class", "p-2").html(`<div class="w-3 h-3 rounded-sm" style="background-color:${bibColors[d.bib]}"></div>`);
                tr.append("td").attr("class", "p-2").text(d.ramp);
                tr.append("td").attr("class", "p-2").text(d.dir);
                tr.append("td").attr("class", "p-2").text(d.tactic);
            });
        }

        // --- CHART HELPERS ---
        function drawPieChartAndLegend(chartSelector, legendSelector, data, colorScale) {
            const chart = d3.select(chartSelector).html("");
            const legend = d3.select(legendSelector).html("");
            const total = d3.sum(data, d => d.value);
            if (total === 0) return chart.html('<p class="text-slate-500 text-sm">No data</p>');

            const svg = chart.append("svg").attr("viewBox", "0 0 250 250").attr("class", "w-full h-full");
            const g = svg.append("g").attr("transform", "translate(125,125)");
            const pie = d3.pie().value(d => d.value).sort(null);
            const arc = d3.arc().innerRadius(0).outerRadius(110);
            
            g.selectAll("path").data(pie(data.filter(d => d.value > 0))).join("path").attr("d", arc).attr("fill", d => colorScale(d.data.label)).attr("stroke", "#1e293b").style("stroke-width", "2px");
            
            data.forEach(d => {
                const item = legend.append("div").attr("class", "flex items-center gap-2");
                item.append("div").attr("class", "w-3 h-3 rounded-sm").style("background-color", colorScale(d.label));
                item.append("span").attr("class", "text-xs text-slate-400").text(`${d.label}: ${((d.value / total) * 100).toFixed(0)}%`);
            });
        }

        function calculateTacticLogic(raceData, upstreamGates) {
            raceData.forEach(d => d.displayTactic = "");
            upstreamGates.forEach(gate => {
                const events = raceData.filter(d => d.Gate === gate).sort((a, b) => a.Position - b.Position);
                if (events.length === 0) return;
                events[0].displayTactic = events[0].UpstreamTactic || "";
                for (let i = 1; i < events.length; i++) {
                    const curr = events[i], prev = events[i - 1];
                    if (curr.Action && prev.Action) curr.displayTactic = curr.Action.toUpperCase() === prev.Action.toUpperCase() ? 'FOLLOW' : `SPLIT - ${curr.Action.toUpperCase()}`;
                    else curr.displayTactic = curr.UpstreamTactic;
                }
            });
        }

        function getCalculatedRaceResults(raceData, orderedGates) {
            const bibs = [...new Set(raceData.map(d => d.BIB))];
            const stats = bibs.map(bib => {
                const athleteData = raceData.filter(d => d.BIB === bib);
                const faults = athleteData.filter(d => (d.FaultVal || d.Action || d.Gate || "").toUpperCase().match(/FLT|FAULT|DSQ|DNF|RAL/));
                const nameEntry = athleteData.find(d => d.AthleteName);
                return {
                    bib, name: nameEntry ? formatAthleteName(nameEntry.AthleteName) : bib, 
                    rampPosition: athleteData.find(d => d.Gate === 'Ramp')?.RampPosition || '-',
                    faults: faults.map(f => f.FaultVal || f.Gate || 'Fault'), 
                    faultCount: faults.length, isRAL: faults.some(f => (f.Gate + f.FaultVal + f.Action).toUpperCase().includes("RAL")),
                    originalRank: athleteData.find(d => d.FinalPosition > 0)?.FinalPosition || 99,
                    finishRank: athleteData.find(d => d.FinishRank)?.FinishRank || '-'
                };
            });
            return stats.sort((a, b) => {
                if (a.isRAL !== b.isRAL) return a.isRAL ? 1 : -1;
                if (a.faultCount !== b.faultCount) return a.faultCount - b.faultCount;
                return a.originalRank - b.originalRank;
            }).map((a, i) => ({ ...a, calculatedRank: i + 1 }));
        }

        function updateFaultAnalysis(selector, raceData, orderedGates) {
            const container = d3.select(selector).html("");
            if (raceData.length === 0) return container.classed("hidden", true);
            const results = getCalculatedRaceResults(raceData, orderedGates);
            container.classed("hidden", false);
            const grid = container.append("div").attr("class", "grid md:grid-cols-2 gap-4");
            const left = grid.append("div");
            left.append("h4").attr("class", "font-bold mb-2 text-slate-400 uppercase text-xs").text("Fault Status");
            results.forEach(a => {
                const row = left.append("div").attr("class", "flex justify-between text-sm py-1 border-b border-slate-700");
                row.append("span").text(a.name);
                row.append("span").attr("class", a.faultCount > 0 ? "text-red-400" : "text-slate-500").text(a.faultCount > 0 ? a.faults.join(", ") : "Clean");
            });
            const right = grid.append("div");
            right.append("h4").attr("class", "font-bold mb-2 text-slate-400 uppercase text-xs").text("Updated Result");
            results.forEach(a => {
                const row = right.append("div").attr("class", "flex gap-2 text-sm py-1 border-b border-slate-700");
                row.append("span").attr("class", "w-4 text-right font-mono").text(a.calculatedRank);
                row.append("div").attr("class", "w-3 h-3 mt-1 rounded-sm").style("background-color", bibColors[a.bib.toLowerCase()]);
                row.append("span").text(a.name);
            });
        }

        function setupSeasonSummaryTab() {
            const years = [...new Set(masterDataFull.map(d => d.Year))].sort((a, b) => b - a);
            selectorsSummary.year.selectAll("option").data(years).join("option").attr("value", d => d).text(d => d);
            selectorsSummary.year.on("change", updateSeasonSummaryAthletes);
            selectorsSummary.athlete.on("change", generateSeasonSummary);
            updateSeasonSummaryAthletes();
        }

        function updateSeasonSummaryAthletes() {
            const year = +selectorsSummary.year.property("value");
            const names = [...new Set(masterDataFull.filter(d => d.Year === year).map(d => formatAthleteName(d.AthleteName)))].filter(n => n).sort();
            selectorsSummary.athlete.html("").append("option").text("Select Athlete...").attr("value", "");
            selectorsSummary.athlete.selectAll("option.val").data(names).join("option").attr("class", "val").attr("value", d => d).text(d => d);
            d3.select("#summary-content-area").html("");
        }

        function generateSeasonSummary() {
            const area = d3.select("#summary-content-area").html("");
            const year = +selectorsSummary.year.property("value"), name = selectorsSummary.athlete.property("value");
            if (!name) return;
            const data = masterDataFull.filter(d => d.Year === year && formatAthleteName(d.AthleteName) === name);
            const table = area.append("div").attr("class", "overflow-x-auto bg-slate-800 rounded-xl border border-slate-700").append("table").attr("class", "w-full text-sm");
            const thead = table.append("thead").attr("class", "bg-slate-700 text-slate-400 text-xs");
            thead.append("tr").selectAll("th").data(['Comp', 'Phase', 'Bib', 'Rank', 'Notes']).join("th").attr("class", "p-3").text(d => d);
            const tbody = table.append("tbody");
            data.filter(d => d.Gate === 'Ramp').forEach(run => {
                const race = masterDataFull.filter(d => d.Competition === run.Competition && d.Phase === run.Phase && d.Gender === run.Gender);
                const res = getCalculatedRaceResults(race, scanCompetitionStructure(year, run.Competition, masterDataFull).orderedGates).find(r => r.name === name);
                const tr = tbody.append("tr").attr("class", "border-t border-slate-700");
                tr.append("td").attr("class", "p-3").text(run.Competition);
                tr.append("td").attr("class", "p-3").text(run.Phase);
                tr.append("td").attr("class", "p-3").html(`<div class="w-3 h-3 rounded-sm" style="background-color:${bibColors[run.BIB.toLowerCase()]}"></div>`);
                tr.append("td").attr("class", "p-3 font-bold").text(res?.calculatedRank || '-');
                tr.append("td").attr("class", "p-3 italic text-slate-500").text(res?.isRAL ? 'RAL' : res?.faultCount > 0 ? 'Fault' : 'Clean');
            });
        }

        // Generic Chart Drawing Function
        function drawLineChart(selector, data, names, order, domain, upstreams, rampPositions) {
            const svg = d3.select(selector);
            svg.selectAll("*").remove();
            if (data.length === 0) return showInitialMessage(selector, "No matching race data found.");
            
            const container = d3.select(svg.node().parentNode);
            const width = container.node().getBoundingClientRect().width;
            const height = container.node().getBoundingClientRect().height || 600;
            const m = { t: 50, r: 20, b: 30, l: 60 };
            
            const chart = svg.append("g").attr("transform", `translate(${m.l},${m.t})`);
            const x = d3.scalePoint().domain(domain).range([0, width - m.l - m.r]).padding(0.5);
            const y = d3.scaleLinear().domain([0.8, 5.2]).range([0, height - m.t - m.b]);

            chart.append("g").attr("class", "x-axis").call(d3.axisTop(x).tickSize(-(height - m.t - m.b)));
            chart.append("g").attr("class", "y-axis").call(d3.axisLeft(y).ticks(5).tickFormat(d3.format("d")).tickSize(-(width - m.l - m.r)));

            const grouped = d3.group(data, d => d.BIB);
            const line = d3.line().x(d => x(d.Gate)).y(d => y(d.Position));

            grouped.forEach((vals, bib) => {
                const color = bibColors[bib] || bibColors[bib.toLowerCase()] || '#64748b';
                
                chart.append("path")
                    .datum(vals.sort((a,b) => domain.indexOf(a.Gate) - domain.indexOf(b.Gate)))
                    .attr("fill", "none")
                    .attr("stroke", color)
                    .attr("stroke-width", 3)
                    .attr("d", line);
                
                chart.selectAll(`.dot-${bib}`).data(vals).join("circle")
                    .attr("cx", d => x(d.Gate))
                    .attr("cy", d => y(d.Position))
                    .attr("r", 4)
                    .attr("fill", color);
                
                vals.forEach(d => {
                    if (d.displayTactic) {
                        chart.append("text")
                            .attr("x", x(d.Gate))
                            .attr("y", y(d.Position) - 10)
                            .attr("text-anchor", "middle")
                            .attr("class", "text-[10px] font-bold")
                            .style("fill", color)
                            .text(d.displayTactic);
                    }
                });
            });

            // Ramp Position down in bottom left
            if (rampPositions && rampPositions.size > 0) {
                const sortedRamps = Array.from(rampPositions).sort((a, b) => a[1] - b[1]);
                const yBase = height - m.t - m.b - (sortedRamps.length * 15);
                
                chart.append("text")
                    .attr("x", -10)
                    .attr("y", yBase - 15)
                    .attr("text-anchor", "end")
                    .style("font-size", "10px")
                    .style("font-weight", "bold")
                    .style("fill", "#94a3b8")
                    .text("Ramp Pos:");

                sortedRamps.forEach(([bib, pos], i) => {
                    const fullName = names.get(bib);
                    const lastName = fullName ? fullName.split(' ')[0] : (bibFullNames[bib] || bib);
                    const color = bibColors[bib] || bibColors[bib.toLowerCase()] || '#64748b';
                    
                    const textNode = chart.append("text")
                        .attr("x", -10)
                        .attr("y", yBase + (i * 14))
                        .attr("text-anchor", "end")
                        .style("fill", color)
                        .style("font-size", "10px");
                        
                    textNode.append("tspan").style("font-weight", "bold").text(`${lastName}: `);
                    textNode.append("tspan").style("font-weight", "normal").text(pos);
                });
            }
        }

        function updateAllChartsFull() {
            if (masterDataFull.length === 0) return;
            const sel = { 
                year: selectorsFull.year.property("value") === 'All' ? 'All' : +selectorsFull.year.property("value"), 
                comp: selectorsFull.competition.property("value"), 
                gen: selectorsFull.gender.property("value"), 
                ph: selectorsFull.phase.property("value") 
            };
            
            const struct = scanCompetitionStructure(sel.year, sel.comp, masterDataFull);
            
            const raw = masterDataFull.filter(d => {
                const matchYear = sel.year === 'All' || d.Year === sel.year;
                const matchComp = sel.comp === 'All' || d.Competition === sel.comp;
                const matchGen = sel.gen === 'All' || d.Gender === sel.gen;
                const matchPh = sel.ph === 'All' || d.Phase === sel.ph;
                return matchYear && matchComp && matchGen && matchPh;
            });

            calculateTacticLogic(raw, struct.upstreamGates);
            const bibMap = new Map();
            const rampMap = new Map();
            raw.filter(d => d.Gate === 'Ramp').forEach(d => {
                if (d.AthleteName) bibMap.set(d.BIB, formatAthleteName(d.AthleteName));
                if (d.RampPosition) rampMap.set(d.BIB, d.RampPosition);
            });
            
            const domain = [...struct.orderedGates, 'Finish'];
            const lineData = [];
            const bibsInSelection = [...new Set(raw.map(d => d.BIB))];
            
            bibsInSelection.forEach(bib => {
                const athlete = raw.filter(d => d.BIB === bib);
                lineData.push(...athlete.filter(d => !['Ramp', 'Finish'].includes(d.Gate)));
                const fin = athlete.find(d => d.FinalPosition > 0);
                if (fin) lineData.push({ BIB: bib, Gate: 'Finish', Position: fin.FinalPosition });
            });
            
            drawLineChart("#chart-full", lineData, bibMap, struct.orderedGates, domain, struct.upstreamGates, rampMap);
            updateFaultAnalysis("#fault-analysis-full", raw, struct.orderedGates);
        }

        function updateAllChartsCompact() {
            if (masterDataCompact.length === 0) return;
            const sel = { 
                year: selectorsCompact.year.property("value") === 'All' ? 'All' : +selectorsCompact.year.property("value"), 
                comp: selectorsCompact.competition.property("value"), 
                gen: selectorsCompact.gender.property("value"), 
                ph: selectorsCompact.phase.property("value") 
            };
            
            const struct = scanCompetitionStructure(sel.year, sel.comp, masterDataCompact);
            
            const raw = masterDataCompact.filter(d => {
                const matchYear = sel.year === 'All' || d.Year === sel.year;
                const matchComp = sel.comp === 'All' || d.Competition === sel.comp;
                const matchGen = sel.gen === 'All' || d.Gender === sel.gen;
                const matchPh = sel.ph === 'All' || d.Phase === sel.ph;
                return matchYear && matchComp && matchGen && matchPh;
            });

            calculateTacticLogic(raw, struct.upstreamGates);
            const bibMap = new Map();
            const rampMap = new Map();
            raw.filter(d => d.Gate === 'Ramp').forEach(d => {
                if (d.AthleteName) bibMap.set(d.BIB, formatAthleteName(d.AthleteName));
                if (d.RampPosition) rampMap.set(d.BIB, d.RampPosition);
            });
            
            const domain = [...struct.orderedGates, 'Finish'];
            const lineData = [];
            const bibsInSelection = [...new Set(raw.map(d => d.BIB))];

            bibsInSelection.forEach(bib => {
                const athlete = raw.filter(d => d.BIB === bib);
                lineData.push(...athlete.filter(d => !['Ramp', 'Finish'].includes(d.Gate)));
                const fin = athlete.find(d => d.FinalPosition > 0);
                if (fin) lineData.push({ BIB: bib, Gate: 'Finish', Position: fin.FinalPosition });
            });
            
            drawLineChart("#chart-compact", lineData, bibMap, struct.orderedGates, domain, struct.upstreamGates, rampMap);
            updateFaultAnalysis("#fault-analysis-compact", raw, struct.orderedGates);
        }

        document.addEventListener('DOMContentLoaded', loadInitialData);
    </script>
</body>

</html>
